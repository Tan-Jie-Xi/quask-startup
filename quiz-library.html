<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz Library – Quask</title>
  <style>
    /* Base Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      background-color: #f8fafc;
      min-height: 100vh;
      line-height: 1.5;
      color: #334155;
      display: flex;
      flex-direction: column;
    }

    /* Header Styles */
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 2.5rem;
      background: #ffffff;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    /* Hamburger */
    .hamburger {
      font-size: 24px;
      cursor: pointer;
      color: #64748b;
      padding: 8px;
      border-radius: 6px;
      transition: background-color 0.2s ease;
    }

    .hamburger:hover {
      background-color: #f1f5f9;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: #d98c0b;
    }

    .profile-section {
      position: relative;
    }

    .profile-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e0e7ff;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      font-size: 1rem;
      color: #3730a3;
      font-weight: 600;
      border: 2px solid #c7d2fe;
      cursor: pointer;
      background-size: cover;
      background-position: center;
    }

    /* Dropdown menu */
    .dropdown {
      display: none;
      position: absolute;
      right: 0;
      top: 50px;
      background-color: #ffbd59;
      border-radius: 8px;
      box-shadow: 0px 4px 12px rgba(0,0,0,0.15);
      min-width: 180px;
      overflow: hidden;
      z-index: 25;
      border: 1px solid #e2e8f0;
    }

    .dropdown strong {
      display: block;
      padding: 12px 16px;
      font-size: 0.875rem;
      background: #ffbd59;
      color: #1f2937;
      border-bottom: 1px solid #e2e8f0;
    }

    .dropdown a {
      display: block;
      padding: 12px 16px;
      text-decoration: none;
      color: #334155;
      font-size: 0.875rem;
      transition: background-color 0.2s ease;
    }

    .dropdown a:hover {
      background-color: #f1f5f9;
    }

    /* Sidebar Navigation */
    .sidebar {
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100vh;
      background: #ffde59;
      z-index: 100;
      transition: left 0.3s ease;
      overflow-y: auto;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
    }

    .sidebar.show {
      left: 0;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-logo img {
      /* Remove size constraints to use natural image size */
    }

    .sidebar-logo span {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
    }

    .close-btn {
      font-size: 24px;
      cursor: pointer;
      color: #1f2937;
      padding: 8px;
      border-radius: 6px;
      transition: background-color 0.2s ease;
    }

    .close-btn:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .nav-section {
      margin: 20px 0;
      padding: 0 20px;
    }

    .nav-section h2 {
      font-weight: 700;
      color: #d98c0b;
      margin-bottom: 15px;
      font-size: 1.1rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .nav-links {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .nav-links a {
      padding: 12px 16px;
      text-decoration: none;
      font-size: 0.875rem;
      color: #d98c0b;
      border-radius: 8px;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .nav-links a:hover {
      background-color: rgba(217, 140, 11, 0.1);
      color: #b8750a;
    }

    /* Overlay for sidebar */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 50;
      display: none;
    }

    .sidebar-overlay.show {
      display: block;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .page-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: #000000;
      text-align: center;
      margin-bottom: 2rem;
    }

    .library-container {
      max-width: 1000px;
      width: 100%;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .empty-state h3 {
      font-size: 1.5rem;
      color: #6b7280;
      margin-bottom: 1rem;
    }

    .empty-state p {
      color: #9ca3af;
      margin-bottom: 2rem;
    }

    .action-btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease;
      background: #f59e0b;
      color: white;
      text-decoration: none;
      display: inline-block;
    }

    .action-btn:hover {
      background: #d97706;
    }

    .quiz-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .quiz-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
      transition: all 0.2s ease;
    }

    .quiz-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .quiz-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .quiz-name {
      font-size: 1.2rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 0.5rem;
    }

    .quiz-topic {
      font-size: 0.9rem;
      color: #6b7280;
      font-style: italic;
    }

    .quiz-meta {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.875rem;
      color: #6b7280;
    }

    .quiz-info {
      margin: 1rem 0;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.25rem;
      font-size: 0.875rem;
    }

    .info-label {
      color: #6b7280;
    }

    .info-value {
      color: #374151;
      font-weight: 500;
    }

    .quiz-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .quiz-btn {
      flex: 1;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .view-btn {
      background: #3b82f6;
      color: white;
    }

    .view-btn:hover {
      background: #2563eb;
    }

    .take-btn {
      background: #10b981;
      color: white;
    }

    .take-btn:hover {
      background: #059669;
    }

    .edit-btn {
      background: #f59e0b;
      color: white;
      flex: 0 0 auto;
      padding: 0.5rem;
    }

    .edit-btn:hover {
      background: #d97706;
    }

    .delete-btn {
      background: #ef4444;
      color: white;
      flex: 0 0 auto;
      padding: 0.5rem;
    }

    .delete-btn:hover {
      background: #dc2626;
    }

    .quiz-timestamp {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 0.5rem;
    }

    /* Footer */
    footer {
      text-align: center;
      padding: 1.5rem;
      background: #ffffff;
      border-top: 1px solid #e2e8f0;
      color: #64748b;
      font-size: 0.875rem;
    }

    @media (max-width: 768px) {
      .quiz-grid {
        grid-template-columns: 1fr;
      }

      .page-title {
        font-size: 2rem;
      }

      .quiz-actions {
        flex-direction: column;
      }

      .quiz-btn {
        flex: none;
      }
    }

    /* Quiz viewer modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-content {
      background: #ffffff;
      border-radius: 12px;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 2rem;
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #6b7280;
      padding: 0.5rem;
      border-radius: 4px;
    }

    .close-btn:hover {
      background: #f3f4f6;
    }

    .question-item {
      margin-bottom: 2rem;
      padding: 1.5rem;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: #f8fafc;
    }

    .question-number {
      font-weight: 600;
      color: #f59e0b;
      margin-bottom: 0.5rem;
    }

    .question-text {
      font-size: 1.1rem;
      color: #1f2937;
      margin-bottom: 1rem;
    }

    .answer-text {
      color: #059669;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .explanation-text {
      color: #6b7280;
      font-style: italic;
      font-size: 0.9rem;
    }

    .options-list {
      margin: 0.5rem 0 1rem 1rem;
      color: #374151;
    }
  </style>
</head>
<body>
  <!-- Sidebar Navigation -->
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <img src="assets/logo.png" alt="Logo">
        <img src="assets/quask.png" alt="Quask">
      </div>
      <span class="close-btn" onclick="closeSidebar()">&times;</span>
    </div>

    <div class="nav-section">
      <h2>Dashboard</h2>
      <div class="nav-links">
        <a href="dashboard.html">Back to Dashboard</a>
        <a href="question-generator.html">Question Generator</a>
        <a href="quiz-library.html">Quiz Library</a>
        <a href="progress-tracker.html">Class Progress Tracker</a>
        <a href="name-selector.html">Random Name Selector</a>
        <a href="fact-checker.html">AI Fact Checker</a>
      </div>
    </div>

    <div class="nav-section">
      <h2>Account Settings</h2>
      <div class="nav-links">
        <a href="../profilepicture.html">Profile Picture</a>
        <a href="username.html">Username</a>
        <a href="#" id="nav-logout">Log Out</a>
      </div>
    </div>
  </div>

  <header class="dashboard-header">
    <div class="header-left">
      <span class="hamburger" onclick="toggleSidebar()">&#9776;</span>
      <div class="logo" onclick="window.location.href='dashboard.html'">
        Quask
      </div>
    </div>
    <div class="profile-section">
      <div class="profile-avatar" id="profile-avatar">
        <span id="avatar-initial">?</span>
      </div>
      <!-- Dropdown menu -->
      <div class="dropdown" id="dropdownMenu">
        <strong>Settings</strong>
        <a href="../profilepicture.html">Profile Picture</a>
        <a href="username.html">Username</a>
        <a href="#" id="dropdown-logout">Log Out</a>
      </div>
    </div>
  </header>

  <main class="main-content">
    <h1 class="page-title">Quiz Library</h1>

    <!-- Filter Controls -->
    <div style="margin-bottom: 2rem; padding: 1.5rem; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
      <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <div style="min-width: 200px;">
          <label style="display: block; margin-bottom: 0.5rem; color: #d97706; font-weight: 500;">Filter by Grade:</label>
          <select id="grade-filter" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; background: white; font-size: 1rem;">
            <option value="">All Grades</option>
            <option value="primary" data-grades="1,2,3,4,5,6">Primary (Primary 1-6)</option>
            <option value="secondary" data-grades="7,8,9,10,11">Secondary (Form 1-5)</option>
            <option value="Primary 1" data-curriculum="KSSR">Primary 1 (KSSR)</option>
            <option value="Primary 2" data-curriculum="KSSR">Primary 2 (KSSR)</option>
            <option value="Primary 3" data-curriculum="KSSR">Primary 3 (KSSR)</option>
            <option value="Primary 4" data-curriculum="KSSR">Primary 4 (KSSR)</option>
            <option value="Primary 5" data-curriculum="KSSR">Primary 5 (KSSR)</option>
            <option value="Primary 6" data-curriculum="KSSR,Cambridge Primary,IB Primary">Primary 6 (KSSR/Cambridge/IB)</option>
            <option value="Form 1" data-curriculum="KSSM,IGCSE,IB Middle Years">Form 1 (KSSM/IGCSE/IB)</option>
            <option value="Form 2" data-curriculum="KSSM,IGCSE,IB Middle Years">Form 2 (KSSM/IGCSE/IB)</option>
            <option value="Form 3" data-curriculum="KSSM,IGCSE,IB Middle Years">Form 3 (KSSM/IGCSE/IB)</option>
            <option value="Form 4" data-curriculum="KSSM,IGCSE,IB Middle Years,A-Levels">Form 4 (KSSM/IGCSE/IB/A-Levels)</option>
            <option value="Form 5" data-curriculum="KSSM,IGCSE,IB Middle Years,A-Levels">Form 5 (KSSM/IGCSE/IB/A-Levels)</option>
          </select>
        </div>
        <div style="min-width: 150px;">
          <label style="display: block; margin-bottom: 0.5rem; color: #d97706; font-weight: 500;">Subject:</label>
          <select id="subject-filter" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; background: white; font-size: 1rem;">
            <option value="">All Subjects</option>
            <option value="Math">Math</option>
            <option value="Science">Science</option>
            <option value="English">English</option>
            <option value="History">History</option>
            <option value="Geography">Geography</option>
            <option value="Physics">Physics</option>
            <option value="Chemistry">Chemistry</option>
            <option value="Biology">Biology</option>
          </select>
        </div>
        <div style="margin-top: 1.5rem;">
          <button id="clear-filters" style="padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: background-color 0.2s;">
            Clear Filters
          </button>
        </div>
      </div>
    </div>

    <div class="library-container">
      <div id="empty-state" class="empty-state">
        <h3>No saved quizzes yet</h3>
        <p>Create and save quizzes in the Question Generator to see them here.</p>
        <a href="question-generator.html" class="action-btn">Create Your First Quiz</a>
      </div>

      <div id="quiz-grid" class="quiz-grid" style="display: none;">
        <!-- Quiz cards will be populated here -->
      </div>
    </div>
  </main>

  <!-- Quiz Viewer Modal -->
  <div class="modal-overlay" id="quiz-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-quiz-name">Quiz Name</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div id="modal-quiz-content">
        <!-- Quiz content will be loaded here -->
      </div>
    </div>
  </div>

  <footer>
    <p>© 2025 Quask. All rights reserved.</p>
  </footer>

  <script type="module" src="firebase-config.js"></script>
  <script type="module">
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    
    // Use shared Firebase instances
    let auth, firebaseManager;
    
    // Wait for Firebase to be ready
    window.firebaseReady.then(({ auth: firebaseAuth }) => {
      auth = firebaseAuth;
      
      // FirebaseDataManager is optional - only create if available
      if (window.FirebaseDataManager) {
        try {
          firebaseManager = new window.FirebaseDataManager();
        } catch (e) {
          console.log('FirebaseDataManager not available, using localStorage only');
        }
      }
      
      // Initialize page after Firebase is ready
      initializePage();
    }).catch(err => {
      console.error('Firebase initialization error:', err);
      // Still initialize page even if Firebase fails
      initializePage();
    });

    // Filter functionality
    function applyFilters(quizzes) {
      const gradeFilter = document.getElementById('grade-filter')?.value || '';
      const subjectFilter = document.getElementById('subject-filter')?.value || '';
      
      if (!gradeFilter && !subjectFilter) {
        return quizzes;
      }
      
      return quizzes.filter(quiz => {
        let gradeMatch = true;
        let subjectMatch = true;
        
        // Grade filtering
        if (gradeFilter) {
          if (gradeFilter === 'primary') {
            // Handle both old "Grade X" and new "Primary X" formats
            let grade = null;
            if (quiz.grade?.startsWith('Primary ')) {
              grade = parseInt(quiz.grade.replace('Primary ', ''));
            } else if (quiz.grade?.startsWith('Grade ')) {
              grade = parseInt(quiz.grade.replace('Grade ', ''));
            }
            gradeMatch = grade >= 1 && grade <= 6;
          } else if (gradeFilter === 'secondary') {
            // Handle both old "Grade X" and new "Form X" formats
            let grade = null;
            if (quiz.grade?.startsWith('Form ')) {
              const formNumber = parseInt(quiz.grade.replace('Form ', ''));
              grade = formNumber + 6; // Form 1 = Grade 7, etc.
            } else if (quiz.grade?.startsWith('Grade ')) {
              grade = parseInt(quiz.grade.replace('Grade ', ''));
            }
            gradeMatch = grade >= 7 && grade <= 11;
          } else {
            gradeMatch = quiz.grade === gradeFilter;
          }
        }
        
        // Subject filtering
        if (subjectFilter) {
          subjectMatch = quiz.subject === subjectFilter;
        }
        
        return gradeMatch && subjectMatch;
      });
    }
    
    // Setup filter event listeners
    function setupFilters() {
      const gradeFilter = document.getElementById('grade-filter');
      const subjectFilter = document.getElementById('subject-filter');
      const clearFilters = document.getElementById('clear-filters');
      
      if (gradeFilter) {
        gradeFilter.addEventListener('change', () => {
          loadSavedQuizzes();
        });
      }
      
      if (subjectFilter) {
        subjectFilter.addEventListener('change', () => {
          loadSavedQuizzes();
        });
      }
      
      if (clearFilters) {
        clearFilters.addEventListener('click', () => {
          if (gradeFilter) gradeFilter.value = '';
          if (subjectFilter) subjectFilter.value = '';
          loadSavedQuizzes();
        });
      }
    }

    // DOM elements
    const emptyState = document.getElementById('empty-state');
    const quizGrid = document.getElementById('quiz-grid');
    const quizModal = document.getElementById('quiz-modal');
    const modalQuizName = document.getElementById('modal-quiz-name');
    const modalQuizContent = document.getElementById('modal-quiz-content');
    const avatar = document.getElementById("profile-avatar");
    const avatarInitial = document.getElementById("avatar-initial");
    const dropdown = document.getElementById("dropdownMenu");

    // Sidebar navigation functions
    window.toggleSidebar = function() {
      const sidebar = document.getElementById("sidebar");
      const overlay = document.getElementById("sidebar-overlay");
      sidebar.classList.add("show");
      overlay.classList.add("show");
    }

    window.closeSidebar = function() {
      const sidebar = document.getElementById("sidebar");
      const overlay = document.getElementById("sidebar-overlay");
      sidebar.classList.remove("show");
      overlay.classList.remove("show");
    }

    // Toggle dropdown on avatar click
    avatar.addEventListener("click", () => {
      dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
    });

    // Close dropdown if clicked outside
    window.addEventListener("click", (e) => {
      if (!avatar.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.style.display = "none";
      }
    });

    // Load saved quizzes from Firebase and localStorage
    async function loadSavedQuizzes() {
      try {
        let savedQuizzes = [];
        
        // Always try localStorage first for reliability
        const localQuizzes = JSON.parse(localStorage.getItem('savedQuizzes') || '[]');
        console.log(`Found ${localQuizzes.length} quizzes in localStorage`);
        
        // Try Firebase if available and authenticated
        if (firebaseManager && auth && auth.currentUser) {
          try {
            const firebaseQuizzes = await firebaseManager.getQuizzes(auth.currentUser.uid);
            console.log(`Loaded ${firebaseQuizzes.length} quizzes from Firebase`);
            // Use Firebase quizzes if they exist, otherwise use local
            savedQuizzes = firebaseQuizzes.length > 0 ? firebaseQuizzes : localQuizzes;
          } catch (firebaseError) {
            console.warn('Failed to load from Firebase:', firebaseError);
            savedQuizzes = localQuizzes;
          }
        } else {
          console.log('Using localStorage quizzes (Firebase not ready or not authenticated)');
          savedQuizzes = localQuizzes;
        }
        
        // Check for search query in URL
        const urlParams = new URLSearchParams(window.location.search);
        const searchQuery = urlParams.get('search');
        
        let quizzesToDisplay = savedQuizzes;
        let isSearchResult = false;
        
        // Apply filters
        quizzesToDisplay = applyFilters(savedQuizzes);
        
        // Clean up any existing search result elements first
        const existingSearchElements = document.querySelectorAll('.search-result-element');
        existingSearchElements.forEach(element => element.remove());
        
        // Filter quizzes if there's a search query
        if (searchQuery) {
          isSearchResult = true;
          const query = searchQuery.toLowerCase();
          quizzesToDisplay = quizzesToDisplay.filter(quiz => {
            return (quiz.name || '').toLowerCase().includes(query) ||
                   (quiz.subject || '').toLowerCase().includes(query) ||
                   (quiz.topic || '').toLowerCase().includes(query) ||
                   (quiz.grade || '').toLowerCase().includes(query) ||
                   (quiz.questions && quiz.questions.some(q => 
                     (q.question || '').toLowerCase().includes(query)
                   ));
          });
          
          // Update page title to show search results (textContent is safe)
          document.querySelector('.page-title').textContent = `Search Results for "${searchQuery}"`;
          
          // Add a "Show All Quizzes" button
          const backButton = document.createElement('button');
          backButton.textContent = 'Show All Quizzes';
          backButton.className = 'action-btn search-result-element';
          backButton.style.cssText = 'margin-bottom: 1rem; font-size: 0.875rem;';
          backButton.onclick = () => {
            window.location.href = 'quiz-library.html';
          };
          document.querySelector('.page-title').insertAdjacentElement('afterend', backButton);
        } else {
          // Reset page title to default when not searching
          document.querySelector('.page-title').textContent = 'Quiz Library';
        }
        
        // Sort by timestamp (newest first)
        const quizzes = quizzesToDisplay.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        if (quizzes.length === 0) {
          if (isSearchResult) {
            emptyState.style.display = 'block';
            quizGrid.style.display = 'none';
            emptyState.innerHTML = `
              <div class="empty-state-icon">🔍</div>
              <div class="empty-state-title">No Results Found</div>
              <div class="empty-state-description" id="no-results-description">
                No quizzes match your search. Try a different search term or browse all quizzes.
              </div>
              <div class="empty-state-action">
                <button onclick="window.location.href='quiz-library.html'" class="action-btn">Browse All Quizzes</button>
              </div>
            `;
            // Safely set the search query using textContent
            document.getElementById('no-results-description').textContent = `No quizzes match your search for "${searchQuery}". Try a different search term or browse all quizzes.`;
          } else {
            emptyState.style.display = 'block';
            quizGrid.style.display = 'none';
          }
          return;
        }

        // Add search result count if showing search results
        if (isSearchResult) {
          const countMessage = document.createElement('p');
          countMessage.textContent = `Found ${quizzes.length} quiz${quizzes.length !== 1 ? 'es' : ''} matching "${searchQuery}"`;
          countMessage.className = 'search-result-element';
          countMessage.style.cssText = 'margin-bottom: 1rem; color: #6b7280; font-style: italic; font-size: 0.9rem;';
          document.querySelector('.page-title').insertAdjacentElement('afterend', countMessage);
        }

        emptyState.style.display = 'none';
        quizGrid.style.display = 'grid';

        quizGrid.innerHTML = '';
        quizzes.forEach((quiz, index) => {
          const quizCard = createQuizCard(quiz, index);
          quizGrid.appendChild(quizCard);
        });
      } catch (error) {
        console.error("Error loading quizzes: ", error);
        // Optionally show an error message to the user
      }
    }

    function createQuizCard(quiz, index) {
      const card = document.createElement('div');
      card.className = 'quiz-card';

      // Ensure timestamp exists and is valid before formatting
      const timestamp = quiz.timestamp ? new Date(quiz.timestamp).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      }) : 'N/A';

      card.innerHTML = `
        <div class="quiz-header">
          <div>
            <div class="quiz-name">${quiz.name}</div>
            <div class="quiz-topic">${quiz.topic}</div>
          </div>
        </div>

        <div class="quiz-info">
          <div class="info-row">
            <span class="info-label">Class:</span>
            <span class="info-value">${quiz.className || 'Unnamed Class'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Subject:</span>
            <span class="info-value">${quiz.subject}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Grade:</span>
            <span class="info-value">${quiz.grade}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Questions:</span>
            <span class="info-value">${quiz.questions?.length || 0}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Type:</span>
            <span class="info-value">${quiz.settings?.questionType === 'mix' ? 'Mixed' : quiz.settings?.questionType === 'multiple-choice' ? 'Multiple Choice' : 'Written'}</span>
          </div>
        </div>

        <div class="quiz-actions">
          <button class="quiz-btn view-btn" onclick="viewQuiz('${quiz.id}', ${index})">View Questions</button>
          <button class="quiz-btn take-btn" onclick="takeQuiz('${quiz.id}', ${index})">Take Quiz</button>
          <button class="quiz-btn" style="background: #8b5cf6; color: white;" onclick="viewQuizResults('${quiz.id}')" title="View Results History">📊</button>
          <button class="quiz-btn edit-btn" onclick="editQuiz('${quiz.id}', ${index})" title="Edit Quiz">✏️</button>
          <button class="quiz-btn delete-btn" onclick="deleteQuiz('${quiz.id}', ${index})" title="Delete Quiz">🗑️</button>
        </div>

        <div class="quiz-timestamp">Created: ${timestamp}</div>
      `;

      return card;
    }

    // View quiz results history for a specific quiz
    window.viewQuizResults = function(quizId) {
      try {
        // Get all quiz results from localStorage
        const savedResults = JSON.parse(localStorage.getItem('quizResultsHistory') || '[]');
        
        // Filter results for this specific quiz only
        const quizSpecificResults = savedResults.filter(result => {
          // If no quiz ID provided, show all results (for backwards compatibility)
          if (!quizId) return true;
          
          // Primary match: exact quiz ID match
          if (result.quizId && result.quizId === quizId) return true;
          
          // Secondary match: for legacy results without quizId, use strict matching
          if (!result.quizId && result.quizName) {
            const quiz = JSON.parse(localStorage.getItem('savedQuizzes') || '[]').find(q => q.id === quizId);
            if (quiz && result.quizName === quiz.name) {
              // Create a settings signature to ensure we're matching the exact same quiz
              const quizSignature = `${quiz.subject}|${quiz.grade}|${quiz.topic}|${quiz.questions?.length || 0}`;
              const resultSignature = `${result.quizSettings?.subject || ''}|${result.quizSettings?.grade || ''}|${result.quizSettings?.topic || ''}|${result.results?.length || 0}`;
              
              // Only match if signatures are identical
              return quizSignature === resultSignature;
            }
          }
          
          return false;
        });
        
        // Sort by most recent first (newest result should be #1)
        const sortedResults = quizSpecificResults.sort((a, b) => {
          const dateA = new Date(a.timestamp);
          const dateB = new Date(b.timestamp);
          return dateB.getTime() - dateA.getTime(); // Newest first
        });

        // Create results modal
        const resultsModal = document.createElement('div');
        resultsModal.className = 'modal-overlay show';
        resultsModal.innerHTML = `
          <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
              <h2 class="modal-title">Your Quiz Results History</h2>
              <button class="close-btn" onclick="this.closest('.modal-overlay').remove()">&times;</button>
            </div>
            <div style="max-height: 70vh; overflow-y: auto;">
              ${sortedResults.length === 0 ? 
                '<div style="text-align: center; padding: 2rem; color: #6b7280;"><p>No results found for this quiz yet.</p><p>Take this quiz to see your results here!</p></div>' :
                sortedResults.map((result, rIndex) => {
                  // Newest result should be "Quiz Result 1", second newest "Quiz Result 2", etc.
                  const displayNumber = rIndex + 1;
                  return `
                  <div style="margin-bottom: 1.5rem; padding: 1.5rem; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                      <div>
                        <h3 style="font-size: 1.1rem; font-weight: 600; color: #1f2937;">Quiz Result ${displayNumber}</h3>
                        <p style="font-size: 0.875rem; color: #6b7280;">${new Date(result.timestamp).toLocaleDateString('en-US', {
                          year: 'numeric',
                          month: 'short',
                          day: 'numeric',
                          hour: '2-digit',
                          minute: '2-digit'
                        })}</p>
                      </div>
                      <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: ${result.score.percentage >= 80 ? '#10b981' : result.score.percentage >= 60 ? '#f59e0b' : '#ef4444'};">
                          ${result.score.correct}/${result.score.total}
                        </div>
                        <div style="font-size: 0.875rem; color: #6b7280;">${result.score.percentage}%</div>
                      </div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                      <strong>Class:</strong> ${result.className || 'N/A'}
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem; font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem;">
                      <div><strong>Subject:</strong> ${result.quizSettings?.subject || 'N/A'}</div>
                      <div><strong>Grade:</strong> ${result.quizSettings?.grade || 'N/A'}</div>
                      <div><strong>Questions:</strong> ${result.results?.length || 0}</div>
                    </div>
                    ${result.results && result.results.length > 0 ? `
                      <details style="margin-top: 1rem;">
                        <summary style="cursor: pointer; font-weight: 500; color: #374151;">View Question Details</summary>
                        <div style="margin-top: 0.75rem; padding-left: 1rem;">
                          ${result.results.map((answer, qIndex) => `
                            <div style="margin-bottom: 1rem; padding: 0.75rem; border-left: 3px solid ${answer.isCorrect ? '#10b981' : '#ef4444'}; background: ${answer.isCorrect ? '#f0fdf4' : '#fef2f2'};">
                              <div style="font-weight: 500; margin-bottom: 0.5rem;">Q${qIndex + 1}: ${answer.question.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#x27;')}</div>
                              <div style="font-size: 0.875rem; color: #6b7280;">
                                <strong>Your Answer:</strong> ${answer.userAnswer.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#x27;')}<br>
                                <strong>Correct Answer:</strong> ${answer.correctAnswer.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#x27;')}<br>
                                <strong>Status:</strong> <span style="color: ${answer.isCorrect ? '#10b981' : '#ef4444'};">${answer.isCorrect ? 'Correct' : 'Incorrect'}</span>
                              </div>
                            </div>
                          `).join('')}
                        </div>
                      </details>
                    ` : ''}
                  </div>
                `;
                }).join('')}
            </div>
          </div>
        `;

        document.body.appendChild(resultsModal);
      } catch (error) {
        console.error("Error loading quiz results: ", error);
        alert('Error loading quiz results. Please try again.');
      }
    };

    // View quiz details
    window.viewQuiz = function(quizId, index) {
      try {
        // Get quizzes from localStorage
        const savedQuizzes = JSON.parse(localStorage.getItem('savedQuizzes') || '[]');
        const quiz = savedQuizzes.find(q => q.id === quizId);

        if (!quiz) {
          console.error("Quiz not found!");
          return;
        }

        modalQuizName.textContent = quiz.name;

        let content = `
          <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f3f4f6; border-radius: 8px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.9rem;">
              <div><strong>Subject:</strong> ${quiz.subject}</div>
              <div><strong>Grade:</strong> ${quiz.grade}</div>
              <div><strong>Topic:</strong> ${quiz.topic}</div>
              <div><strong>Questions:</strong> ${quiz.questions?.length || 0}</div>
            </div>
          </div>
        `;

        if (quiz.questions && quiz.questions.length > 0) {
          quiz.questions.forEach((question, qIndex) => {
            content += `
              <div class="question-item">
                <div class="question-number">Question ${qIndex + 1}</div>
                <div class="question-text">${question.question}</div>

                ${question.type === 'multiple-choice' ? `
                  <div class="options-list">
                    A. ${question.options[0]}<br>
                    B. ${question.options[1]}<br>
                    C. ${question.options[2]}<br>
                    D. ${question.options[3]}
                  </div>
                  <div class="answer-text">Correct Answer: ${question.correctAnswer}</div>
                ` : `
                  <div class="answer-text">Expected Answer: ${question.correctAnswer}</div>
                `}

                <div class="explanation-text">Explanation: ${question.explanation}</div>
              </div>
            `;
          });
        } else {
          content += '<p>No questions found in this quiz.</p>';
        }

        modalQuizContent.innerHTML = content;
        quizModal.classList.add('show');
      } catch (error) {
        console.error("Error viewing quiz: ", error);
        // Optionally show an error message to the user
      }
    };

    // Take quiz
    window.takeQuiz = function(quizId, index) {
      try {
        // Get quizzes from localStorage
        const savedQuizzes = JSON.parse(localStorage.getItem('savedQuizzes') || '[]');
        const quiz = savedQuizzes.find(q => q.id === quizId);

        if (!quiz) {
          console.error("Quiz not found!");
          return;
        }

        // Transfer quiz questions directly to quiz mode
        sessionStorage.setItem('generatedQuestions', JSON.stringify({
          id: quiz.id,
          name: quiz.name,
          questions: quiz.questions,
          settings: {
            grade: quiz.grade,
            subject: quiz.subject,
            syllabus: quiz.syllabus,
            language: quiz.language,
            topic: quiz.topic,
            shuffle: quiz.settings?.shuffle || false,
            questionType: quiz.settings?.questionType || 'mix',
            questionCount: quiz.questions?.length || 5
          }
        }));

        // Pass quiz ID and name via URL parameters for proper tracking
        window.location.href = `quiz-mode.html?quizId=${encodeURIComponent(quiz.id)}&quizName=${encodeURIComponent(quiz.name)}`;
      } catch (error) {
        console.error("Error taking quiz: ", error);
        // Optionally show an error message to the user
      }
    };

    // Edit quiz
    window.editQuiz = function(quizId, index) {
      try {
        // Get quizzes from localStorage
        const savedQuizzes = JSON.parse(localStorage.getItem('savedQuizzes') || '[]');
        const quiz = savedQuizzes.find(q => q.id === quizId);

        if (!quiz) {
          console.error("Quiz not found!");
          return;
        }

        // Create edit form modal
        const editModal = document.createElement('div');
        editModal.className = 'modal-overlay show';
        editModal.innerHTML = `
          <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
              <h2 class="modal-title">Edit Quiz: ${quiz.name}</h2>
              <button class="close-btn" onclick="this.closest('.modal-overlay').remove()">&times;</button>
            </div>
            <div style="max-height: 70vh; overflow-y: auto;">
              <div id="edit-questions">
                ${quiz.questions.map((question, qIndex) => `
                  <div class="question-item" style="margin-bottom: 2rem; padding: 1.5rem; border: 1px solid #e2e8f0; border-radius: 8px;">
                    <div style="margin-bottom: 1rem;">
                      <label style="font-weight: 600; color: #1f2937;">Question ${qIndex + 1}:</label>
                      <textarea id="question-${qIndex}" style="width: 100%; min-height: 80px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; margin-top: 0.5rem;">${question.question}</textarea>
                    </div>

                    ${question.type === 'multiple-choice' ? `
                      <div style="margin-bottom: 1rem;">
                        <label style="font-weight: 600; color: #1f2937;">Options:</label>
                        <div style="margin-top: 0.5rem;">
                          <input type="text" id="option-${qIndex}-0" value="${question.options[0]}" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; margin-bottom: 0.5rem;" placeholder="Option A">
                          <input type="text" id="option-${qIndex}-1" value="${question.options[1]}" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; margin-bottom: 0.5rem;" placeholder="Option B">
                          <input type="text" id="option-${qIndex}-2" value="${question.options[2]}" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; margin-bottom: 0.5rem;" placeholder="Option C">
                          <input type="text" id="option-${qIndex}-3" value="${question.options[3]}" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; margin-bottom: 0.5rem;" placeholder="Option D">
                        </div>
                      </div>
                      <div style="margin-bottom: 1rem;">
                        <label style="font-weight: 600; color: #1f2937;">Correct Answer (A, B, C, or D):</label>
                        <input type="text" id="answer-${qIndex}" value="${question.correctAnswer}" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; margin-top: 0.5rem;" maxlength="1">
                      </div>
                    ` : `
                      <div style="margin-bottom: 1rem;">
                        <label style="font-weight: 600; color: #1f2937;">Expected Answer:</label>
                        <textarea id="answer-${qIndex}" style="width: 100%; min-height: 60px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; margin-top: 0.5rem;">${question.correctAnswer}</textarea>
                      </div>
                    `}

                    <div>
                      <label style="font-weight: 600; color: #1f2937;">Explanation:</label>
                      <textarea id="explanation-${qIndex}" style="width: 100%; min-height: 60px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; margin-top: 0.5rem;">${question.explanation}</textarea>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
            <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
              <button onclick="this.closest('.modal-overlay').remove()" style="padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 6px; cursor: pointer;">Cancel</button>
              <button onclick="saveEditedQuiz('${quizId}', ${index})" style="padding: 0.75rem 1.5rem; border: none; background: #10b981; color: white; border-radius: 6px; cursor: pointer;">Save Changes</button>
            </div>
          </div>
        `;

        document.body.appendChild(editModal);
      } catch (error) {
        console.error("Error editing quiz: ", error);
        // Optionally show an error message to the user
      }
    };

    // Delete quiz
    window.deleteQuiz = async function(quizId, index) {
      console.log('Delete quiz called with ID:', quizId, 'Index:', index);
      
      if (confirm(`Are you sure you want to delete this quiz? This action cannot be undone.`)) {
        try {
          console.log('User confirmed deletion, proceeding...');
          
          // Always delete from localStorage first (most reliable)
          const savedQuizzes = JSON.parse(localStorage.getItem('savedQuizzes') || '[]');
          console.log('Before deletion:', savedQuizzes.length, 'quizzes');
          
          const updatedQuizzes = savedQuizzes.filter(quiz => quiz.id !== quizId);
          localStorage.setItem('savedQuizzes', JSON.stringify(updatedQuizzes));
          console.log('After deletion:', updatedQuizzes.length, 'quizzes remaining');
          
          // Try to delete from Firebase if available
          if (firebaseManager && auth && auth.currentUser) {
            try {
              await firebaseManager.deleteQuiz(auth.currentUser.uid, quizId);
              console.log('Quiz also deleted from Firebase');
            } catch (firebaseError) {
              console.warn('Failed to delete from Firebase (but localStorage deletion succeeded):', firebaseError);
            }
          } else {
            console.log('Firebase not available, but localStorage deletion completed');
          }
          
          // Reload quizzes after deletion
          await loadSavedQuizzes();
          console.log('Quiz deletion completed and list refreshed');
          
        } catch (error) {
          console.error("Error deleting quiz: ", error);
          alert('Error deleting quiz. Please try again.');
        }
      } else {
        console.log('User cancelled deletion');
      }
    };

    // Save edited quiz
    window.saveEditedQuiz = function(quizId, index) {
      const updatedQuestions = [];

      // Collect updated question data
      for (let qIndex = 0; qIndex < document.querySelectorAll(`#edit-questions .question-item`).length; qIndex++) {
        const questionText = document.getElementById(`question-${qIndex}`).value;
        const explanation = document.getElementById(`explanation-${qIndex}`).value;

        let questionData = {
          question: questionText,
          explanation: explanation
        };

        // Check if it's a multiple-choice question to get options and correct answer
        const mcOptions = document.querySelectorAll(`#edit-questions .question-item`)[qIndex].querySelector(`input[id^="option-${qIndex}"]`);
        if (mcOptions) {
          questionData.type = 'multiple-choice';
          questionData.options = [
            document.getElementById(`option-${qIndex}-0`).value,
            document.getElementById(`option-${qIndex}-1`).value,
            document.getElementById(`option-${qIndex}-2`).value,
            document.getElementById(`option-${qIndex}-3`).value
          ];
          questionData.correctAnswer = document.getElementById(`answer-${qIndex}`).value.toUpperCase();
        } else {
          // Assuming it's a written question if not multiple-choice
          questionData.type = 'written';
          questionData.correctAnswer = document.getElementById(`answer-${qIndex}`).value;
        }
        updatedQuestions.push(questionData);
      }

      try {
        // Get existing quizzes from localStorage
        const savedQuizzes = JSON.parse(localStorage.getItem('savedQuizzes') || '[]');
        
        // Find and update the quiz
        const quizIndex = savedQuizzes.findIndex(quiz => quiz.id === quizId);
        if (quizIndex !== -1) {
          savedQuizzes[quizIndex].questions = updatedQuestions;
          
          // Save back to localStorage
          localStorage.setItem('savedQuizzes', JSON.stringify(savedQuizzes));
          
          // Close modal and refresh
          document.querySelector('.modal-overlay.show').remove();
          loadSavedQuizzes();

          alert('Quiz updated successfully!');
        } else {
          console.error("Quiz not found for update");
          alert('Error: Quiz not found. Please try again.');
        }
      } catch (error) {
        console.error("Error saving edited quiz: ", error);
        alert('Error saving quiz changes. Please try again.');
      }
    };

    // Close modal
    window.closeModal = function() {
      quizModal.classList.remove('show');
    };

    // Close modal when clicking overlay
    quizModal.addEventListener('click', (e) => {
      if (e.target === quizModal) {
        closeModal();
      }
    });

    // Go back function
    window.goBack = function() {
      window.location.href = 'dashboard.html';
    };

    // Initialize page when Firebase is ready
    function initializePage() {
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "login.html";
        } else {
          // Update avatar
          if (user.photoURL) {
            avatar.style.backgroundImage = `url(${user.photoURL})`;
            avatarInitial.style.display = "none";
          } else {
            avatarInitial.textContent = user.email.charAt(0).toUpperCase();
          }
          
          // Initialize filters and load quizzes
          setupFilters();
          await loadSavedQuizzes();
        }
      });
    }

    // Handle logout
    function doLogout() {
      signOut(auth).then(() => {
        window.location.href = "login.html";
      });
    }

    document.getElementById("nav-logout").addEventListener("click", doLogout);
    document.getElementById("dropdown-logout").addEventListener("click", doLogout);
  </script>

  <script src='https://storage.ko-fi.com/cdn/scripts/overlay-widget.js'></script>
  <script>
    kofiWidgetOverlay.draw('quaskspace', {
      'type': 'floating-chat',
      'floating-chat.donateButton.text': 'Support me',
      'floating-chat.donateButton.background-color': '#fcbf47',
      'floating-chat.donateButton.text-color': '#323842'
    });
  </script>
</body>
</html>